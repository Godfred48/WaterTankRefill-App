{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Delivery Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 960px;
            margin: auto;
            padding: 2rem;
        }

        .card {
            border: none;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
        }

        #mapid {
            height: 450px !important;
            min-height: 450px;
            border-radius: 12px;
            width: 100%; /* Ensure map takes full width of its container */
        }

        .info-label {
            font-weight: bold;
            color: #555;
        }

        .info-value {
            color: #000;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h2 {
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>Live Delivery Tracking</h2>
        <p class="text-muted">Delivery ID: {{ delivery.delivery_id }}</p>
    </div>

    <div class="card p-4 mb-4">
        <h5 class="mb-3">Delivery Info</h5>
        <div class="row">
            <div class="col-md-6 mb-2">
                <span class="info-label">Customer:</span>
                <span class="info-value">{{ delivery.order.customer.full_name }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Pickup Location:</span>
                <span class="info-value">{{ delivery.order.delivery_location }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Destination:</span>
                <span class="info-value">{{ delivery.delivery_location }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Driver:</span>
                <span class="info-value">{{ delivery.driver.user.full_name }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Driver Location:</span>
                <span class="info-value" id="driver-location">Waiting for update...</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Customer Location:</span>
                <span class="info-value" id="customer-location">
                    {% if delivery.customer_lat and delivery.customer_lng %}
                        {{ delivery.customer_lat|floatformat:6 }}, {{ delivery.customer_lng|floatformat:6 }}
                    {% else %}
                        Location not available
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="card p-0">
        <div id="mapid"></div>
    </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript">
    const deliveryId = "{{ delivery.delivery_id }}";
    const socket = new WebSocket(`ws://${window.location.host}/ws/delivery/${deliveryId}/`);

    let map = null;
    let driverMarker = null;
    let customerMarker = null;

    // Get customer coordinates from the delivery object
    const customerLat = {{ delivery.customer_lat|default:"null" }};  // changed default to null
    const customerLng = {{ delivery.customer_lng|default:"null" }};

    function initMap(centerLat, centerLng) {
        if (!map) {
            map = L.map('mapid').setView([centerLat, centerLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }
    }

    function updateMarkers(driverLat, driverLng) {
        const truckIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2920/2920067.png', // Truck icon
            iconSize: [40, 40],
            iconAnchor: [20, 40],
        });

        const homeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2523/2523088.png',  // Home icon for customer
            iconSize: [35, 35],
            iconAnchor: [17, 35],
        });

        if (!driverMarker) {
            driverMarker = L.marker([driverLat, driverLng], { icon: truckIcon }).addTo(map).bindPopup('Driver Location');
        } else {
            driverMarker.setLatLng([driverLat, driverLng]);
        }

        // Add customer marker
        if (!customerMarker && customerLat && customerLng) {
            customerMarker = L.marker([customerLat, customerLng], { icon: homeIcon }).addTo(map).bindPopup('Customer Location');
        } else if (customerMarker && customerLat && customerLng) {
            customerMarker.setLatLng([customerLat, customerLng]);
        }
        //If customer Marker does not have a location.
        else if (customerLat && customerLng){
             customerMarker = L.marker([customerLat, customerLng], { icon: homeIcon }).addTo(map).bindPopup('Customer Location');
        }

    }

    function sendDriverLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                document.getElementById('driver-location').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

                socket.send(JSON.stringify({ lat, lng }));

                // Initialize map and set customer location on initial load
                if (!map) {
                    initMap(lat, lng); //center on driver
                    updateMarkers(lat,lng);
                }
                else{
                     updateMarkers(lat, lng);
                }


            }, error => {
                console.error("Error getting driver location:", error);
                // Handle error (e.g., show message to driver)
                document.getElementById('driver-location').textContent = "Location unavailable";
            }, {
                enableHighAccuracy: true, // Request high accuracy
                timeout: 10000,           // Timeout after 10 seconds
                maximumAge: 5000         // Don't use cached location older than 5 seconds
            });
        } else {
            console.error("Geolocation is not supported by this browser.");
            document.getElementById('driver-location').textContent = "Geolocation not supported";
        }
    }

    socket.onopen = () => {
        console.log("WebSocket connected");
        sendDriverLocation(); // Get and send driver's location immediately on connection
        setInterval(sendDriverLocation, 5000); // Update every 5 seconds
    };

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "location_update") {
            const lat = parseFloat(data.lat);
            const lng = parseFloat(data.lng);
            if (!map) {
                initMap(lat, lng);
            }
            updateMarkers(lat, lng);
        }
    };

    socket.onclose = () => {
        console.warn("WebSocket connection closed.");
    };
</script>
</body>
</html>
