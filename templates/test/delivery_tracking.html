{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Delivery Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 960px;
            margin: auto;
            padding: 2rem;
        }

        .card {
            border: none;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
        }

        #mapid {
            height: 450px !important;
            min-height: 450px;
            border-radius: 12px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
        }

        .info-value {
            color: #000;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h2 {
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>Live Delivery Tracking</h2>
        <p class="text-muted">Delivery ID: {{ delivery.delivery_id }}</p>
    </div>

    <div class="card p-4 mb-4">
        <h5 class="mb-3">Delivery Info</h5>
        <div class="row">
            <div class="col-md-6 mb-2">
                <span class="info-label">Customer:</span>
                <span class="info-value">{{ delivery.order.customer.full_name }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Pickup Location:</span>
                <span class="info-value">{{ delivery.pickup_location }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Destination:</span>
                <span class="info-value">{{ delivery.destination }}</span>
            </div>
            <div class="col-md-6 mb-2">
                <span class="info-label">Current Driver Location:</span>
                <span class="info-value" id="driver-location">Waiting for update...</span>
            </div>
        </div>
    </div>

    <div class="card p-0">
        <div id="mapid"></div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const deliveryId = "{{ delivery.delivery_id }}";
    const socket = new WebSocket(`ws://${window.location.host}/ws/delivery/${deliveryId}/`);

    let map = null;
    let driverMarker = null;
    let customerMarker = null;

    const customerLat = {{ delivery.order.customer.profile.latitude|default:5.6037 }};
    const customerLng = {{ delivery.order.customer.profile.longitude|default:-0.1870 }};

    function initMap(centerLat, centerLng) {
        if (!map) {
            map = L.map('mapid').setView([centerLat, centerLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }
    }

    function updateMarkers(driverLat, driverLng) {
        const truckIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2920/2920067.png',
            iconSize: [40, 40],
            iconAnchor: [20, 40],
        });

        if (!driverMarker) {
            driverMarker = L.marker([driverLat, driverLng], { icon: truckIcon }).addTo(map).bindPopup('Driver');
        } else {
            driverMarker.setLatLng([driverLat, driverLng]);
        }

        if (!customerMarker) {
            customerMarker = L.marker([customerLat, customerLng], {
                icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png',
                    iconSize: [35, 35],
                    iconAnchor: [17, 35],
                })
            }).addTo(map).bindPopup('Customer');
        } else {
            customerMarker.setLatLng([customerLat, customerLng]);
        }
    }

    function sendDriverLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                document.getElementById('driver-location').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

                socket.send(JSON.stringify({ lat, lng }));

                if (!map) initMap(lat, lng);
                updateMarkers(lat, lng);
            });
        }
    }

    socket.onopen = () => {
        console.log("WebSocket connected");
        sendDriverLocation();
        setInterval(sendDriverLocation, 5000); // Update every 5 seconds
    };

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "location_update") {
            const lat = parseFloat(data.lat);
            const lng = parseFloat(data.lng);
            if (!map) initMap(lat, lng);
            updateMarkers(lat, lng);
        }
    };

    socket.onclose = () => {
        console.warn("WebSocket connection closed.");
    };
</script>
</body>
</html>
